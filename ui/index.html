<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pentimento</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        /* Bevy WASM canvas (Tauri/Electron mode only) */
        #bevy-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            display: none; /* Hidden by default, shown in Tauri mode */
        }
        /* UI overlay */
        #app {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        /* Only specific UI components should capture events */
    </style>
</head>
<body>
    <!-- Bevy WASM canvas (only visible in Tauri/Electron mode) -->
    <canvas id="bevy-canvas"></canvas>

    <!-- Svelte UI overlay -->
    <div id="app"></div>

    <script type="module" src="/src/main.ts"></script>

    <!-- Load Bevy WASM in Tauri/Electron mode -->
    <script>
        function initBevyWasm() {
            console.log('Pentimento: Initializing Bevy WASM...');
            var canvas = document.getElementById('bevy-canvas');
            if (canvas) {
                canvas.style.display = 'block';
                console.log('Pentimento: Canvas made visible');
            }
            // Dynamically create script tag to load WASM module
            var script = document.createElement('script');
            script.type = 'module';
            script.textContent = 'import init from "./wasm/pentimento_wasm.js"; console.log("Pentimento: Loading WASM..."); init().then(() => console.log("Pentimento: WASM loaded!")).catch(err => console.error("Failed to load Bevy WASM:", err));';
            document.body.appendChild(script);
        }

        function isWasmMode() {
            // Check for Tauri globals (v1 uses __TAURI__, v2 uses __TAURI_INTERNALS__)
            // or Electron global (set by preload script)
            return '__TAURI__' in window ||
                   '__TAURI_INTERNALS__' in window ||
                   '__ELECTRON__' in window;
        }

        function checkAndInit() {
            if (isWasmMode()) {
                var mode = '__ELECTRON__' in window ? 'Electron' : 'Tauri';
                console.log('Pentimento: ' + mode + ' mode detected');
                initBevyWasm();
                return true;
            }
            return false;
        }

        // Try immediately
        if (!checkAndInit()) {
            // If not detected yet, try after DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                if (!checkAndInit()) {
                    // Final attempt after a short delay (runtime might inject globals late)
                    setTimeout(function() {
                        if (!checkAndInit()) {
                            console.log('Pentimento: Running in native mode (no WASM runtime detected)');
                        }
                    }, 100);
                }
            });
        }
    </script>
</body>
</html>
